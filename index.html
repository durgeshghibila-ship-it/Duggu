<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Audio Server (manual SDP)</title></head>
<body>
  <h2>ChromeOS Full System Audio — Server</h2>
  <button id="start">Start capture & create offer</button>
  <p>Offer (copy to client):</p>
  <textarea id="offer" rows="8" cols="80"></textarea>
  <p>Paste client answer here:</p>
  <textarea id="answer" rows="8" cols="80"></textarea><br>
  <button id="setAnswer">Set Answer</button>
  <script>
    const startBtn = document.getElementById('start');
    const offerBox = document.getElementById('offer');
    const answerBox = document.getElementById('answer');
    const setAnswerBtn = document.getElementById('setAnswer');

    const pc = new RTCPeerConnection();
    pc.onicecandidate = e => {
      if (e.candidate === null) {
        // localDescription will contain full SDP once ICE gathering finished
        offerBox.value = JSON.stringify(pc.localDescription);
      }
    };

    startBtn.onclick = async () => {
      try {
        // Capture system audio by asking to share display with audio
        const stream = await navigator.mediaDevices.getDisplayMedia({ audio: true, video: false });
        // Attach tracks to PeerConnection
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        // Wait for ICE gathering to complete; onicecandidate handler will fill offer
        offerBox.value = "Gathering ICE... please wait until this area is populated automatically.";
      } catch (err) {
        alert('Error capturing display audio: ' + err);
      }
    };

    setAnswerBtn.onclick = async () => {
      try {
        const answer = JSON.parse(answerBox.value);
        await pc.setRemoteDescription(answer);
        alert('Answer set — client should be connected.');
      } catch (err) {
        alert('Error setting answer: ' + err);
      }
    };
  </script>
</body>
</html>
