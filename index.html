<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ChromeOS Audio Host</title>
</head>
<body>
  <h2>ChromeOS Audio Host</h2>
  <button id="start">Start Streaming</button>
  <p>Scan this QR code with your phone:</p>
  <canvas id="qr"></canvas>
  <pre id="log"></pre>

  <script type="module">
    import * as QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';

    const startBtn = document.getElementById("start");
    const qrCanvas = document.getElementById("qr");
    const log = document.getElementById("log");
    let pc = new RTCPeerConnection();

    function logMsg(msg) {
      console.log(msg);
      log.textContent += msg + "\n";
    }

    startBtn.onclick = async () => {
      try {
        // Capture microphone audio
        logMsg("Requesting microphone audio...");
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(track => pc.addTrack(track, stream));

        // Create offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        logMsg("Offer created.");

        // Encode offer as base64 for QR
        const offerBase64 = btoa(JSON.stringify(offer));
        const url = `${location.origin}/client.html?offer=${offerBase64}`;

        // Generate QR code
        QRCode.toCanvas(qrCanvas, url, err => {
          if (err) logMsg("QR code error: " + err);
          else logMsg("QR code ready. Scan it with your phone!");
        });

      } catch (err) {
        logMsg("Error: " + err.message);
        alert("Failed to access microphone. Make sure Chrome has permission.");
      }
    };

    // Handle answer from client
    window.addEventListener("message", async e => {
      if (e.data.type === "answer") {
        await pc.setRemoteDescription(e.data.answer);
        logMsg("âœ… Client connected. Audio streaming started!");
      }
    });
  </script>
</body>
</html>
